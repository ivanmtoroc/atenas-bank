{% extends "base.html" %}
{% load staticfiles %}

{% block title %} Users {% endblock title %}

{% block page_title %} Users administration {% endblock page_title %}

{% block breadcrumb %}
<li><a href="{% url 'home:home' %}">Home</a></li>
<li class="active">Users</li>
{% endblock breadcrumb %}

{% block panel %}{% endblock panel %}

{% block table_title %}
Users
<a @click="cleanForm()" href="#modal-create" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#modal-create">
  + New user
</a>
{% endblock table_title %}

{% block table_columns %}
<th class="sorting_asc" tabindex="0" aria-controls="table" rowspan="1" colspan="1">Full name</th>
<th class="sorting" tabindex="0" aria-controls="table" rowspan="1" colspan="1">Username</th>
<th class="sorting" tabindex="0" aria-controls="table" rowspan="1" colspan="1">Cedula</th>
<th class="sorting" tabindex="0" aria-controls="table" rowspan="1" colspan="1">Email</th>
<th class="sorting" tabindex="0" aria-controls="table" rowspan="1" colspan="1">Position</th>
<th class="sorting" tabindex="0" aria-controls="table" rowspan="1" colspan="1">Status</th>
<th class="sorting" tabindex="0" aria-controls="table" rowspan="1" colspan="1">Actions</th>
{% endblock table_columns %}

{% block table_rows %}
<tr v-for="user in users" role="row" class="odd">
  <td class="sorting_1">${ user.first_name } ${ user.last_name }</td>
  <td>${ user.username }</td>
  <td>${ user.cedula }</td>
  <td>${ user.email }</td>
  <td>${ user.position }</td>
  <td class="text-center">
    <p v-if="user.is_active" class="badge bg-green p-bg">Active</p>
    <p v-else class="badge bg-red p-bg">Inactive</p>
  </td>
  <td class="text-center">
    <div class="input-group-btn">
      <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">Actions <span class="fa fa-caret-down"></span></button>
      <ul class="dropdown-menu">
        <li>
          <a @click="getUser(user.cedula)" href="#modal-delete" class="btn btn-sm" :class="[user.is_active ? 'btn-danger' : 'btn-success']" data-toggle="modal" data-target="#modal-delete">
            <span v-if="user.is_active"><i class="fa fa-user-times"></i> Deactivate</span>
            <span v-else><i class="fa fa-user-plus"></i> Activate</span>
          </a>
        </li>
        <li>
          <a @click="getUser(user.cedula)" href="#modal-update" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#modal-update">
            <i class="fa fa-edit"></i> Update
          </a>
        </li>
        <li>
          <a @click="readUser(user.cedula)" href="#modal-read" class="btn btn-info btn-sm" data-toggle="modal" data-target="#modal-read">
            <i class="fa fa-info-circle"></i> Information
          </a>
        </li>
      </ul>
    </div>
  </td>
</tr>
{% endblock table_rows %}

{% block modal_create_title %}<h3>New user</h3>{% endblock modal_create_title %}

{% block modal_create_body %}
<div v-if="showErrors" class="alert alert-danger">
  <h4><i class="icon fa fa-ban"></i> Errors!</h4>
  <ul>
    <li v-for="error in errors">
      <span v-for="e in error">${ e }</span>
    </li>
  </ul>
</div>
<form @submit.prevent="addUser()">
  <div class="row">
    <div class="col-md-6 form-group">
      <label for="cedula">Cedula</label>
      <input id="cedula" placeholder="Cedula" v-model="newUser.cedula" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="username">Username</label>
      <input id="username" placeholder="Username" v-model="newUser.username" type="text" class="form-control" required="required">
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 form-group">
      <label for="first_name">First name</label>
      <input id="first_name" placeholder="First name" v-model="newUser.first_name" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="last_name">Last name</label>
      <input id="last_name" placeholder="Last name" v-model="newUser.last_name" type="text" class="form-control" required="required">
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 form-group">
      <label for="email">Email</label>
      <input id="email" placeholder="Email" v-model="newUser.email" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label>Position</label>
      <select v-model="newUser.position" class="form-control" required="required">
        <option>Operator</option>
        <option>Manager</option>
      </select>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 form-group">
      <label for="address">Address</label>
      <input id="address" placeholder="Address" v-model="newUser.address" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="phone">Phone</label>
      <input id="phone" placeholder="Phone" v-model="newUser.phone" type="text" class="form-control" required="required">
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 form-group">
      <label for="password1">Password</label>
      <input id="password1" placeholder="Password" v-model="newUser.password1" type="password" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="password2">Password confirmation</label>
      <input id="password2" placeholder="Password confirmation" v-model="newUser.password2" type="password" class="form-control" required="required">
    </div>
  </div>
  <div class="pull-right">
    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
    <button type="submit" class="btn btn-success">Save</button>
  </div>
</form>
{% endblock modal_create_body %}

{% block modal_read_title %}<h3>Information</h3>{% endblock modal_read_title %}

{% block modal_read_body %}
<div class="row">
  <div class="col-sm-12">
    <p><strong>Full name:</strong> ${ currentUser.first_name } ${ currentUser.last_name }</p>
    <p><strong>Username:</strong> ${ currentUser.username }</p>
    <p><strong>Email:</strong> ${ currentUser.email }</p>
    <p><strong>Status:</strong> ${ currentUser.is_active ? 'Active' : 'Deactivate' }</p>
  </div>
</div>
{% endblock modal_read_body %}

{% block modal_update_title %}<h3>Update user</h3>{% endblock modal_update_title %}

{% block modal_update_body %}
<div v-if="showErrors" class="alert alert-danger">
  <h4><i class="icon fa fa-ban"></i> Errors!</h4>
  <ul>
    <li v-for="error in errors">
      <span v-for="e in error">${ e }</span>
    </li>
  </ul>
</div>
<form @submit.prevent="updateUser()">
  <div class="row">
    <div class="col-md-6 form-group">
      <label for="cedula2">Cedula</label>
      <input id="cedula2" placeholder="Cedula" v-model="currentUser.cedula" type="text" class="form-control" required="required" readonly>
    </div>
    <div class="col-md-6 form-group">
      <label for="username2">Username</label>
      <input id="username2" placeholder="Username" v-model="currentUser.username" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="first_name2">First name</label>
      <input id="first_name2" placeholder="First name" v-model="currentUser.first_name" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="last_name2">Last name</label>
      <input id="last_name2" placeholder="Last name" v-model="currentUser.last_name" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="email2">Email</label>
      <input id="email2" placeholder="Email" v-model="currentUser.email" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="position2">Position</label>
      <input id="position2" placeholder="Position" v-model="currentUser.position" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="address2">Address</label>
      <input id="address2" placeholder="Address" v-model="currentUser.address" type="text" class="form-control" required="required">
    </div>
    <div class="col-md-6 form-group">
      <label for="phone2">Phone</label>
      <input id="phone2" placeholder="Phone" v-model="currentUser.phone" type="text" class="form-control" required="required">
    </div>
  </div>
  <div class="pull-right">
    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
    <button type="submit" class="btn btn-primary">Update</button>
  </div>
</form>
{% endblock modal_update_body %}

{% block modal_delete_title %}<h3>${ currentUser.is_active ? 'Deactivate' : 'Active' } user</h3>{% endblock modal_delete_title %}

{% block modal_delete_body %}
<div class="row">
  <div class="col-sm-12">
    <p>
      Are you sure to <strong>${ currentUser.is_active ? 'deactivate' : 'active' }</strong>
      the user <strong>${ currentUser.first_name } ${ currentUser.last_name }</strong>?
    </p>
  </div>
</div>
<div class="pull-right">
  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
  <button @click="deleteUser(currentUser.cedula)" type="button" :class="[ currentUser.is_active ? 'btn-danger' : 'btn-success' ]" class="btn">
    ${ currentUser.is_active ? 'Deactivate' : 'Active' }
  </button>
</div>
{% endblock modal_delete_body %}

{% block vue %}
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript">
Vue.prototype.$http = axios
new Vue({
  el: '#app',
  delimiters: ['${','}'],
  data () {
    return {
      users: [],
      currentUser: {},
      newUser: {
        username: null,
        cedula: null,
        first_name: null,
        last_name: null,
        email: null,
        is_active: true,
        position: 'Operator',
        phone: null,
        address: null,
        password1: null,
        password2: null
      },
      errors: {},
      showErrors: false,
      loading: false
    }
  },
  mounted () {
    this.getUsers()
  },
  methods: {
    getUsers () {
      this.loading = true
      this.$http.get('api/users/')
      .then((response) => {
        this.users = response.data
        this.loading = false
      })
      .catch((error) => {
        this.loading = false
        console.log(error)
      })
    },
    getUser (cedula) {
      this.cleanForm()
      this.loading = true
      this.$http.get(`api/users/${cedula}/`)
      .then((response) => {
        this.currentUser = response.data
        this.loading = false
      })
      .catch((error) => {
        this.loading = false
        console.log(error)
      })
    },
    readUser (cedula) {
      this.loading = true
      this.$http.get(`api/users/${cedula}/`)
      .then((response) => {
        this.currentUser = response.data
        $('#modal-read').modal('show')
        this.loading = false
      })
      .catch((error) => {
        this.loading = false
        console.log(error)
      })
    },
    addUser () {
      this.loading = true
      this.$http.post('api/users/', this.newUser)
      .then((response) => {
        this.loading = false
        $('#modal-create').modal('hide')
        this.showErrors = false
        this.getUsers()
      })
      .catch((error) => {
        this.loading = false
        this.errors = error.response.data
        this.showErrors = true
      })
    },
    updateUser () {
      this.loading = true
      this.$http.put(`api/users/${this.currentUser.cedula}/`, this.currentUser)
      .then((response) => {
        this.loading = false
        $('#modal-update').modal('hide')
        this.cleanForm()
        this.showErrors = false
        this.getUsers()
      })
      .catch((error) => {
        this.loading = false
        this.errors = error.response.data
        this.showErrors = true
      })
    },
    deleteUser (cedula) {
      this.loading = true
      this.$http.delete(`api/users/${cedula}/`)
      .then((response) => {
        this.loading = false
        $("#modal-delete").modal('hide')
        this.getUsers()
      })
      .catch((error) => {
        this.loading = false
        console.log(error)
      })
    },
    cleanForm () {
      this.newUser = {
        username: null,
        cedula: null,
        first_name: null,
        last_name: null,
        email: null,
        is_active: true,
        position: 'Operator',
        phone: null,
        address: null,
        password1: null,
        password2: null
      }
      this.showErrors = false
    },
    isEmpty (obj) {
      for (var item in obj) { return false }
      return true
    }
  }
})
</script>
{% endblock vue %}
